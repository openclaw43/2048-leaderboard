name: Benchmark

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'game2048/**/*.py'
      - 'benchmark.py'
      - 'pyproject.toml'
      - '.github/workflows/benchmark.yml'
  workflow_dispatch:

permissions:
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          version: 'latest'
      
      - name: Install dependencies
        run: uv sync
      
      - name: Run benchmarks
        run: uv run python benchmark.py --json --output benchmark_results.json
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.json
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 << 'EOF'
          import json
          import subprocess
          
          with open('benchmark_results.json') as f:
              results = json.load(f)
          
          summary = results.get('summary', {})
          
          if not summary:
              print("No summary data available")
              exit(0)
          
          sorted_agents = sorted(summary.items(), key=lambda x: x[1]['avg_score'], reverse=True)
          
          comment = "## Benchmark Results\n\n"
          comment += "| Rank | Agent | Avg Score | Max Score | Avg Max Tile |\n"
          comment += "|------|-------|-----------|-----------|-------------|\n"
          
          for i, (name, stats) in enumerate(sorted_agents, 1):
              medal = " " if i > 3 else {"1": " ", "2": " ", "3": " "}[str(i)]
              comment += f"| #{i} | **{name}** | {stats['avg_score']:.1f} | {stats['max_score']} | {stats['avg_max_tile']:.1f} |\n"
          
          comment += f"\n_Timestamp: {results.get('timestamp', 'N/A')}_"
          
          with open('pr_comment.md', 'w') as f:
              f.write(comment)
          EOF
          
          if [[ -f pr_comment.md ]]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file pr_comment.md
          fi
